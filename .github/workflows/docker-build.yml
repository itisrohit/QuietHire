name: Docker Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Validate docker-compose.yml
  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker-compose config --quiet

  # Build Go-based services
  build-go-services:
    name: Build Go Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api, proxy-manager]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.service }}/Dockerfile
          push: false
          tags: quiethire-${{ matrix.service }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build API worker image
  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/api/Dockerfile.worker
          push: false
          tags: quiethire-worker:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build Python-based services
  build-python-services:
    name: Build Python Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [parser, crawler-python, osint-discovery]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} image
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.service }}
          file: apps/${{ matrix.service }}/Dockerfile
          push: false
          tags: quiethire-${{ matrix.service }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Test multi-stage builds are optimized
  check-image-sizes:
    name: Check Image Sizes
    runs-on: ubuntu-latest
    needs: [build-go-services, build-python-services]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build all images
        run: |
          docker-compose build api parser crawler-python

      - name: Check image sizes
        run: |
          echo "Image sizes:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep quiethire || true
          
          # Warning if images are too large (optional check)
          echo "Checking for oversized images..."
          for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep quiethire); do
            size=$(docker image inspect $img --format='{{.Size}}')
            size_mb=$((size / 1024 / 1024))
            if [ $size_mb -gt 500 ]; then
              echo "⚠️  Warning: $img is ${size_mb}MB (>500MB)"
            else
              echo "✓ $img: ${size_mb}MB"
            fi
          done

  # Verify Dockerfiles follow best practices
  hadolint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint on all Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "apps/*/Dockerfile*"
          recursive: true
          ignore: DL3008,DL3009,DL3015  # Ignore version pinning warnings
